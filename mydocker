#! /bin/bash

# Usage: mydocker <command> [ args... ]
#
# This wrapper around docker attempts to make the container environment as
# similar as possible to the host environment by performing the following
# magic:
#
# 1. Mounts the `$HOME` directory in docker using the exact same path.
# 2. If `mydocker` is run in (a subdirectory of) `$HOME`, runs the docker
#    instance in the same subdirectory.
# 3. If the `command` argument is found in `$HOME/bin` on the host, runs the
#    identical command in the container.
# 4. If this script is run from an interactive shell, runs docker in
#    interactive mode.
# 5. Runs the container with the same uid and guid as the host.
#
# This script does not attempt to copy over environment variables, preferring
# to let the executed script set things such as the build environment.

dockername=bde-docker-dev
# dockername=bdebuildbase

# If current directory is a subdirectory of $HOME, then set docker instance
# to current directory; otherwise, use the default "/workspace"
wd="/workspace"
if [ "${PWD#$HOME}" != "$PWD" ]; then
   wd="$PWD"
fi

# $homebin is the directory holding favorite custom scripts
homebin="$HOME/bin"

# If `command` is found in `$homebin` folder, use full path to command within
# the container; otherwise, let the container figure out the path on its own.
cmd=$(which "$1")  # Get full path to command (if found outside of container)
if [ "${cmd#$homebin}" = "$cmd" ]; then
    # Command was not found in $homebin, set `$cmd` to argument value and let
    # the container figure out the path on its own.
    cmd="$1"
fi
shift

# If run from an interactive shell, set docker to interactive mode
if tty -s; then
    interactive="-it"
else
    interactive=""
fi

# Run docker with the current uid and gid, mount the $HOME directory using
# same path name, and set the working directory to $wd, and tell it to execute
# the specified command within the container.
exec docker run $interactive --rm -v "$HOME:$HOME" -v "$HOME/bbcm/bde-tools:/bde-tools" -u $(id -u):$(id -g) -w "$wd" $dockername "$cmd" "$@"
